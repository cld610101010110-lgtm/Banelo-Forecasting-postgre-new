# Firebase ID Management Guide

## Overview

This guide explains the `firebase_id` field in your PostgreSQL database and how to ensure it's properly maintained.

## What is `firebase_id`?

The `firebase_id` field stores the Firebase Firestore document ID for records that originated from or sync with your Firebase database (typically from your mobile POS app).

### Database Schema

```sql
-- Products table
CREATE TABLE products (
    id TEXT PRIMARY KEY,              -- UUID generated by mobile app
    firebase_id TEXT UNIQUE,          -- Firebase document ID
    name VARCHAR(255),
    category VARCHAR(100),
    ...
);

-- Sales table
CREATE TABLE sales (
    id SERIAL PRIMARY KEY,
    product_firebase_id VARCHAR(255), -- References products.firebase_id
    product_name VARCHAR(255),
    ...
);

-- Recipes table
CREATE TABLE recipes (
    id TEXT PRIMARY KEY,
    firebase_id TEXT UNIQUE,
    product_firebase_id TEXT,         -- References products.firebase_id
    ...
);

-- Recipe Ingredients table
CREATE TABLE recipe_ingredients (
    id TEXT PRIMARY KEY,
    firebase_id TEXT,
    recipe_firebase_id TEXT,          -- References recipes.firebase_id
    ingredient_firebase_id TEXT,      -- References products.firebase_id
    ...
);
```

## Why `firebase_id` is Important

1. **Cross-Platform Sync**: Allows your mobile app and web dashboard to reference the same records
2. **Data Consistency**: Ensures sales, recipes, and ingredients correctly reference products
3. **Audit Trail**: Maintains the relationship between PostgreSQL and Firebase records
4. **Migration**: Helps when syncing data between systems

## Common Issues

### Issue 1: Missing `firebase_id`

**Symptom**: Products exist but have NULL or empty `firebase_id`

**Cause**:
- Products created directly in PostgreSQL without syncing to Firebase
- Data migration issues

**Impact**:
- Sales cannot properly reference these products
- Recipes cannot use these ingredients
- Cross-platform sync fails

### Issue 2: Duplicate `firebase_id`

**Symptom**: Multiple products have the same `firebase_id`

**Cause**:
- Data import errors
- Manual database modifications

**Impact**:
- Ambiguous product references
- Data integrity issues
- Incorrect sales/recipe associations

### Issue 3: Orphaned References

**Symptom**: Sales or recipes reference `firebase_id` that doesn't exist in products

**Cause**:
- Products deleted but sales remain
- Data sync issues

**Impact**:
- Broken relationships
- Unable to lookup product details
- ML forecasting errors

## Verification & Fix Scripts

### 1. Verify Firebase IDs

Check for any `firebase_id` consistency issues:

```bash
cd /home/user/Banelo-Forecasting-postgre-new/Banelo-Forecasting-main/baneloforecasting
python verify_firebase_ids.py
```

**This script checks:**
- ‚úÖ Products without `firebase_id`
- ‚úÖ Duplicate `firebase_id` values
- ‚úÖ Invalid `firebase_id` format
- ‚úÖ Orphaned recipes (referencing non-existent products)
- ‚úÖ Orphaned sales (referencing non-existent products)
- ‚úÖ Recipe ingredients with invalid references

**Output Example:**
```
üîç VERIFYING PRODUCT FIREBASE IDs
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä Total Products: 71

‚úÖ Products WITHOUT firebase_id: 0
‚úÖ Duplicate firebase_id values: 0

üìã Firebase ID Format Check:
   ‚úÖ Valid format: 71
```

### 2. Fix Firebase ID Issues

Run fixes for any detected issues:

**Dry Run (Safe - No Changes)**
```bash
python fix_firebase_ids.py
```

**Live Mode (Makes Changes)**
```bash
python fix_firebase_ids.py --live
```

**What it fixes:**
1. ‚úÖ Generates `firebase_id` for products missing one
2. ‚úÖ Fixes duplicate `firebase_id` values (keeps first, regenerates others)
3. ‚úÖ Updates related sales and recipes to use new IDs
4. ‚úÖ Attempts to match orphaned records by product name

## Manual Verification via SQL

### Check Products Without firebase_id

```sql
SELECT id, name, category
FROM products
WHERE firebase_id IS NULL OR firebase_id = '';
```

### Check for Duplicate firebase_id

```sql
SELECT firebase_id, COUNT(*) as count
FROM products
WHERE firebase_id IS NOT NULL AND firebase_id != ''
GROUP BY firebase_id
HAVING COUNT(*) > 1;
```

### Check Orphaned Sales

```sql
SELECT s.product_firebase_id, s.product_name, COUNT(*) as sales_count
FROM sales s
LEFT JOIN products p ON s.product_firebase_id = p.firebase_id
WHERE s.product_firebase_id IS NOT NULL
  AND s.product_firebase_id != ''
  AND p.id IS NULL
GROUP BY s.product_firebase_id, s.product_name
ORDER BY sales_count DESC;
```

### Check Firebase ID Format

```sql
-- Firebase IDs are typically 20-28 alphanumeric characters
SELECT id, name, firebase_id, LENGTH(firebase_id) as id_length
FROM products
WHERE firebase_id IS NOT NULL
ORDER BY id_length;
```

## Best Practices

### 1. Always Set firebase_id When Creating Products

**‚ùå Wrong:**
```python
product = Product.objects.create(
    name="Latte",
    category="Beverage"
    # Missing firebase_id!
)
```

**‚úÖ Correct:**
```python
product = Product.objects.create(
    id=str(uuid.uuid4()),
    firebase_id=generate_firebase_id(),  # Or actual Firebase doc ID
    name="Latte",
    category="Beverage"
)
```

### 2. Use firebase_id for Cross-References

**‚ùå Wrong:**
```python
# Don't use Django's internal id for cross-app references
sale = Sale.objects.create(
    product_id=product.id,  # This is the UUID, not firebase_id
    ...
)
```

**‚úÖ Correct:**
```python
sale = Sale.objects.create(
    product_firebase_id=product.firebase_id,  # Use firebase_id
    product_name=product.name,
    ...
)
```

### 3. Regular Verification

Run verification monthly or after:
- Data imports
- Database migrations
- Mobile app updates
- Manual database modifications

```bash
# Add to cron or run manually
python verify_firebase_ids.py
```

## Troubleshooting

### Error: "Products without firebase_id"

**Solution:**
```bash
python fix_firebase_ids.py --live
```

This will generate unique Firebase-like IDs for products missing them.

### Error: "Duplicate firebase_id values"

**Solution:**
```bash
python fix_firebase_ids.py --live
```

This will keep the first occurrence and regenerate IDs for duplicates.

### Error: "Sales with invalid product_firebase_id"

**Causes:**
1. Product was deleted
2. Product firebase_id was changed
3. Sale was created with wrong firebase_id

**Solutions:**

1. **If product exists with different name:**
   ```sql
   UPDATE sales
   SET product_firebase_id = (SELECT firebase_id FROM products WHERE name = 'Latte')
   WHERE product_name = 'Latte';
   ```

2. **If product is missing, create it:**
   ```sql
   INSERT INTO products (id, firebase_id, name, category, price)
   VALUES (uuid_generate_v4(), 'NEW_FB_ID', 'Latte', 'Beverage', 5.99);
   ```

3. **Run fix script:**
   ```bash
   python fix_firebase_ids.py --live
   ```

## Your Current Database Status

Based on the screenshot you provided, your database has:

- ‚úÖ **id**: UUIDs (e.g., `05755b4b-fc48-41f6-8e96-fc782c22a5...`)
- ‚úÖ **firebase_id**: Firebase document IDs (e.g., `54Nmuu1uaJ3R2CzlboB4`)

This is the correct format! Run the verification script to ensure all records are consistent:

```bash
python verify_firebase_ids.py
```

## Support

If you encounter issues:

1. Run verification script first: `python verify_firebase_ids.py`
2. Review the output to understand the issue
3. Run fix script in dry-run mode: `python fix_firebase_ids.py`
4. If fixes look correct, run live: `python fix_firebase_ids.py --live`
5. Verify again: `python verify_firebase_ids.py`

## Files

- `verify_firebase_ids.py` - Verification script
- `fix_firebase_ids.py` - Automated fix script
- `FIREBASE_ID_GUIDE.md` - This guide
- `dashboard/models.py` - Database models with firebase_id fields
